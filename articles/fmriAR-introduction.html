<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting Started with fmriAR • fmriAR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with fmriAR">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmriAR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fmriAR-introduction.html">Getting Started with fmriAR</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting Started with fmriAR</h1>
                        <h4 data-toc-skip class="author">fmriAR
Team</h4>
            
            <h4 data-toc-skip class="date">2025-09-20</h4>
      

      <div class="d-none name"><code>fmriAR-introduction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p><code>fmriAR</code> provides lightweight tools for estimating
autoregressive (AR) or autoregressive–moving-average (ARMA) noise models
from fMRI residuals and applying matched prewhitening to both design
matrices and voxel-wise data. The C++ core keeps large-scale whitening
fast, while the R interface stays compact and flexible.</p>
<p>This vignette walks through a typical workflow. We start by fitting
an AR model to residuals from an initial OLS regression, then apply the
resulting run-aware whitening plan to both the design matrix and the
voxel data. With the innovations in hand we check that low-lag
autocorrelation has been suppressed, explore how multiscale pooling
stabilises parcel-level estimates, and finish with a brief look at ARMA
models when MA structure remains.</p>
</div>
<div class="section level2">
<h2 id="simulating-data-for-the-examples">Simulating data for the examples<a class="anchor" aria-label="anchor" href="#simulating-data-for-the-examples"></a>
</h2>
<p>To make the examples reproducible, we simulate a modest fMRI-style
dataset with two runs, a small design matrix, and voxel-specific AR(2)
noise.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmriAR/">fmriAR</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_time</span> <span class="op">&lt;-</span> <span class="fl">240</span></span>
<span><span class="va">n_vox</span> <span class="op">&lt;-</span> <span class="fl">60</span></span>
<span><span class="va">runs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="va">n_time</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Design matrix: intercept + task regressor</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  intercept <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  task <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="va">n_time</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate voxel time-series with AR(2) noise</span></span>
<span><span class="va">phi_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">n_vox</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">phi_true</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_vox</span>, sd <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">phi_true</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">0.2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_vox</span>, sd <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_time</span>, <span class="va">n_vox</span><span class="op">)</span></span>
<span><span class="va">innov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_time</span> <span class="op">*</span> <span class="va">n_vox</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">n_time</span>, <span class="va">n_vox</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">v</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_vox</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_time</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ar_part</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">ar_part</span> <span class="op">&lt;-</span> <span class="va">ar_part</span> <span class="op">+</span> <span class="va">phi_true</span><span class="op">[</span><span class="va">v</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">Y</span><span class="op">[</span><span class="va">t</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">v</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="va">ar_part</span> <span class="op">&lt;-</span> <span class="va">ar_part</span> <span class="op">+</span> <span class="va">phi_true</span><span class="op">[</span><span class="va">v</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">Y</span><span class="op">[</span><span class="va">t</span> <span class="op">-</span> <span class="fl">2</span>, <span class="va">v</span><span class="op">]</span></span>
<span>    <span class="va">Y</span><span class="op">[</span><span class="va">t</span>, <span class="va">v</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ar_part</span> <span class="op">+</span> <span class="va">innov</span><span class="op">[</span><span class="va">t</span>, <span class="va">v</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Add task signal to half the voxels</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">Y_signal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">Y_signal</span>, <span class="st">"+"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Residuals from initial OLS fit</span></span>
<span><span class="va">coeff_ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qr.html" class="external-link">qr.solve</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="va">resid</span> <span class="op">&lt;-</span> <span class="va">Y</span> <span class="op">-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">coeff_ols</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fitting-an-ar-model">Fitting an AR model<a class="anchor" aria-label="anchor" href="#fitting-an-ar-model"></a>
</h2>
<p>The primary entry point is <code><a href="../reference/fit_noise.html">fit_noise()</a></code>. When
<code>method = "ar"</code> and <code>p = "auto"</code>, the function
selects the AR order per run using BIC, then enforces stationarity.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plan_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_noise.html">fit_noise</a></span><span class="op">(</span></span>
<span>  <span class="va">resid</span>,</span>
<span>  runs <span class="op">=</span> <span class="va">runs</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"ar"</span>,</span>
<span>  p <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  p_max <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  exact_first <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>  pooling <span class="op">=</span> <span class="st">"run"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">plan_ar</span></span>
<span><span class="co"># fmriAR whitening plan</span></span>
<span><span class="co">#   Method: AR</span></span>
<span><span class="co">#   Orders: p = 2, q = 0</span></span>
<span><span class="co">#   Pooling: run</span></span>
<span><span class="co">#   Runs: 2 (1, 2)</span></span>
<span><span class="co">#   Exact first-sample scaling: AR(1)</span></span>
<span><span class="co">#   Coefficients:</span></span>
<span><span class="co">#     1: phi = 0.485, -0.193</span></span>
<span><span class="co">#     2: phi = 0.482, -0.196</span></span></code></pre></div>
<p>The returned <code>fmriAR_plan</code> holds run-specific AR
coefficients and metadata about the estimation procedure.</p>
</div>
<div class="section level2">
<h2 id="whitening-design-and-data-matrices">Whitening design and data matrices<a class="anchor" aria-label="anchor" href="#whitening-design-and-data-matrices"></a>
</h2>
<p><code><a href="../reference/whiten_apply.html">whiten_apply()</a></code> takes the plan, design matrix, and
observed data and returns whitened versions that can be used in GLS
estimation or downstream analyses.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">whitened</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/whiten_apply.html">whiten_apply</a></span><span class="op">(</span><span class="va">plan_ar</span>, <span class="va">X</span>, <span class="va">Y</span>, runs <span class="op">=</span> <span class="va">runs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">whitened</span><span class="op">)</span></span>
<span><span class="co"># List of 2</span></span>
<span><span class="co">#  $ X: num [1:240, 1:2] 1 0.515 0.708 0.708 0.708 ...</span></span>
<span><span class="co">#   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#   .. ..$ : NULL</span></span>
<span><span class="co">#   .. ..$ : chr [1:2] "intercept" "task"</span></span>
<span><span class="co">#  $ Y: num [1:240, 1:60] -1.4936 -1.5949 -0.0306 -1.0101 -0.0617 ...</span></span></code></pre></div>
<p>By default the function returns whitened <code>X</code> and
<code>Y</code>. You can compute GLS coefficients with a single linear
solve:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Xw</span> <span class="op">&lt;-</span> <span class="va">whitened</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="va">Yw</span> <span class="op">&lt;-</span> <span class="va">whitened</span><span class="op">$</span><span class="va">Y</span></span>
<span><span class="va">beta_gls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qr.html" class="external-link">qr.solve</a></span><span class="op">(</span><span class="va">Xw</span>, <span class="va">Yw</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta_gls</span></span>
<span><span class="co">#                 [,1]       [,2]        [,3]       [,4]       [,5]</span></span>
<span><span class="co"># intercept -0.1785576 0.03768029 -0.04137929 0.08983252 0.03839622</span></span>
<span><span class="co"># task       1.6659992 1.38144408  1.18152789 1.45707478 1.53914426</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="inspecting-innovations">Inspecting innovations<a class="anchor" aria-label="anchor" href="#inspecting-innovations"></a>
</h2>
<p>The whitened residuals (innovations) should look close to white
noise. The helper below computes the average absolute autocorrelation
across voxels.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">innov_var</span> <span class="op">&lt;-</span> <span class="va">Yw</span> <span class="op">-</span> <span class="va">Xw</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/qr.html" class="external-link">qr.solve</a></span><span class="op">(</span><span class="va">Xw</span>, <span class="va">Yw</span><span class="op">)</span></span>
<span><span class="va">lag_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">innov_var</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/acf.html" class="external-link">acf</a></span><span class="op">(</span><span class="va">y</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, lag.max <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">$</span><span class="va">acf</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">ac</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lag_stats</span><span class="op">)</span></span>
<span><span class="co"># [1] 0.05721336</span></span></code></pre></div>
<p>For comparison, the same calculation on the pre-whitened residuals is
typically much larger.</p>
<p>In this simulation the mean absolute autocorrelation over lags 1–5
drops by several fold after whitening; exact values vary with the random
seed, but the whitened summary should be markedly smaller than the raw
baseline.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lag_stats_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">resid</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/acf.html" class="external-link">acf</a></span><span class="op">(</span><span class="va">y</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, lag.max <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">$</span><span class="va">acf</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">ac</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lag_stats_raw</span><span class="op">)</span></span>
<span><span class="co"># [1] 0.140151</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_acf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">lag.max</span> <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">acf_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/acf.html" class="external-link">acf</a></span><span class="op">(</span><span class="va">mat</span><span class="op">[</span>, <span class="va">j</span><span class="op">]</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, lag.max <span class="op">=</span> <span class="va">lag.max</span><span class="op">)</span><span class="op">$</span><span class="va">acf</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">acf_vals</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lag_max</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">lag_max</span><span class="op">)</span></span>
<span><span class="va">acf_raw</span> <span class="op">&lt;-</span> <span class="fu">avg_acf</span><span class="op">(</span><span class="va">resid</span>, lag.max <span class="op">=</span> <span class="va">lag_max</span><span class="op">)</span></span>
<span><span class="va">acf_white</span> <span class="op">&lt;-</span> <span class="fu">avg_acf</span><span class="op">(</span><span class="va">innov_var</span>, lag.max <span class="op">=</span> <span class="va">lag_max</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">acf_raw</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, <span class="va">acf_white</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lags</span>, <span class="va">acf_raw</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"h"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"#1b9e77"</span>,</span>
<span>     ylim <span class="op">=</span> <span class="va">ylim</span>, xlab <span class="op">=</span> <span class="st">"Lag"</span>, ylab <span class="op">=</span> <span class="st">"Average autocorrelation"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Mean autocorrelation across voxels"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">lags</span>, <span class="va">acf_white</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"h"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"#d95f02"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"grey70"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Raw residuals"</span>, <span class="st">"Whitened innovations"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#1b9e77"</span>, <span class="st">"#d95f02"</span><span class="op">)</span>,</span>
<span>       lwd <span class="op">=</span> <span class="fl">2</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="fmriAR-introduction_files/figure-html/whiteness-plot-1.png" alt="Average autocorrelation across voxels before and after whitening" width="672"><p class="caption">
Average autocorrelation across voxels before and after whitening
</p>
</div>
</div>
<div class="section level2">
<h2 id="parcel-pooling-and-multiscale-shrinkage">Parcel pooling and multiscale shrinkage<a class="anchor" aria-label="anchor" href="#parcel-pooling-and-multiscale-shrinkage"></a>
</h2>
<p>When per-voxel residuals are noisy, you can pool information across
parcels. The example below constructs synthetic parcels and uses the
multiscale PACF-weighted shrinkage.</p>
<p>Under the hood, <code>fit_noise(..., pooling = "parcel")</code>
builds parcel-level mean residual series at one or more spatial
resolutions (fine/medium/coarse). Each parcel’s AR model is estimated
with run-aware autocovariances, and then the coefficients are shrunk
toward their parents by combining either partial autocorrelations
(“pacf_weighted”) or autocovariance functions (“acvf_pooled”). The
weights depend on parcel size, dispersion across voxels, and the number
of runs, so larger or more homogeneous parcels lend more stability to
their descendants while preserving stationarity for the final per-parcel
filters.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parcels_fine</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, each <span class="op">=</span> <span class="va">n_vox</span> <span class="op">/</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">parcels_medium</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, each <span class="op">=</span> <span class="va">n_vox</span> <span class="op">/</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">parcels_coarse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="va">n_vox</span> <span class="op">/</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plan_parcel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_noise.html">fit_noise</a></span><span class="op">(</span></span>
<span>  <span class="va">resid</span>,</span>
<span>  runs <span class="op">=</span> <span class="va">runs</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"ar"</span>,</span>
<span>  p <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  p_max <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  pooling <span class="op">=</span> <span class="st">"parcel"</span>,</span>
<span>  parcels <span class="op">=</span> <span class="va">parcels_fine</span>,</span>
<span>  parcel_sets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    fine <span class="op">=</span> <span class="va">parcels_fine</span>,</span>
<span>    medium <span class="op">=</span> <span class="va">parcels_medium</span>,</span>
<span>    coarse <span class="op">=</span> <span class="va">parcels_coarse</span></span>
<span>  <span class="op">)</span>,</span>
<span>  multiscale <span class="op">=</span> <span class="st">"pacf_weighted"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">plan_parcel</span><span class="op">$</span><span class="va">order</span></span>
<span><span class="co"># p q </span></span>
<span><span class="co"># 6 0</span></span></code></pre></div>
<p>When parcel pooling is requested, <code><a href="../reference/whiten_apply.html">whiten_apply()</a></code> returns
<code>X_by</code>, a list of whitened design matrices per parcel, along
with the voxel-wise <code>Y</code> innovations.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">whitened_parcel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/whiten_apply.html">whiten_apply</a></span><span class="op">(</span><span class="va">plan_parcel</span>, <span class="va">X</span>, <span class="va">Y</span>, runs <span class="op">=</span> <span class="va">runs</span>, parcels <span class="op">=</span> <span class="va">parcels_fine</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">whitened_parcel</span><span class="op">$</span><span class="va">X_by</span><span class="op">)</span></span>
<span><span class="co"># [1] 12</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fitting-arma-models">Fitting ARMA models<a class="anchor" aria-label="anchor" href="#fitting-arma-models"></a>
</h2>
<p>Some datasets require ARMA models to capture remaining MA structure.
The workflow mirrors the AR case but sets <code>method = "arma"</code>
and supplies orders <code>(p, q)</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plan_arma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_noise.html">fit_noise</a></span><span class="op">(</span></span>
<span>  <span class="va">resid</span>,</span>
<span>  runs <span class="op">=</span> <span class="va">runs</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"arma"</span>,</span>
<span>  p <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  q <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  hr_iter <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">plan_arma</span><span class="op">$</span><span class="va">order</span></span>
<span><span class="co"># p q </span></span>
<span><span class="co"># 2 1</span></span></code></pre></div>
<p>ARMA whitening uses the same <code><a href="../reference/whiten_apply.html">whiten_apply()</a></code>
interface.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">whitened_arma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/whiten_apply.html">whiten_apply</a></span><span class="op">(</span><span class="va">plan_arma</span>, <span class="va">X</span>, <span class="va">Y</span>, runs <span class="op">=</span> <span class="va">runs</span><span class="op">)</span></span>
<span><span class="va">whitened_arma</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></span>
<span><span class="co">#      intercept task</span></span>
<span><span class="co"># [1,] 1.0000000    0</span></span>
<span><span class="co"># [2,] 0.4657323    0</span></span>
<span><span class="co"># [3,] 0.5693939    0</span></span>
<span><span class="co"># [4,] 0.6397975    0</span></span>
<span><span class="co"># [5,] 0.6876133    0</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="afni-style-restricted-ar-filters">AFNI-style restricted AR filters<a class="anchor" aria-label="anchor" href="#afni-style-restricted-ar-filters"></a>
</h2>
<p>If you need to replicate AFNI’s “restricted ARMA” family—real +
complex AR roots with optional additive white noise—<code>fmriAR</code>
provides an internal helper that constructs matching whitening plans.
The function lives inside the package namespace as
<code>fmriAR:::afni_restricted_plan()</code> to keep the public API
focused on the core AR/ARMA workflow, but it produces the same
<code>fmriAR_plan</code> objects used elsewhere.</p>
<p>The helper expects the AFNI root parameterisation (a real root
<code>a</code>, complex pairs defined by radius/angle, and an optional
MA(1) refinement) and can operate globally or per parcel. Because the
interface mirrors AFNI’s internals, it is a convenient bridge when
comparing pipelines or validating fmriAR against established AFNI
analyses.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: AFNI-style AR(3) with optional MA(1) term</span></span>
<span><span class="va">roots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0.6</span>, r1 <span class="op">=</span> <span class="fl">0.7</span>, t1 <span class="op">=</span> <span class="va">pi</span> <span class="op">/</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plan_afni</span> <span class="op">&lt;-</span> <span class="fu">fmriAR</span><span class="fu">:::</span><span class="fu"><a href="../reference/afni_restricted_plan.html">afni_restricted_plan</a></span><span class="op">(</span></span>
<span>  resid <span class="op">=</span> <span class="va">resid</span>,</span>
<span>  runs <span class="op">=</span> <span class="va">runs</span>,</span>
<span>  parcels <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  p <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>  roots <span class="op">=</span> <span class="va">roots</span>,</span>
<span>  estimate_ma1 <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">plan_afni</span><span class="op">$</span><span class="va">order</span></span>
<span></span>
<span><span class="co"># Apply whitening just like any other plan</span></span>
<span><span class="va">whitened_afni</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/whiten_apply.html">whiten_apply</a></span><span class="op">(</span><span class="va">plan_afni</span>, <span class="va">X</span>, <span class="va">Y</span>, runs <span class="op">=</span> <span class="va">runs</span><span class="op">)</span></span></code></pre></div>
<p>Tip: set <code>estimate_ma1 = FALSE</code> to obtain the pure AR
filter implied by the AFNI roots, or provide a list of root
specifications keyed by parcel ID to drive parcel-specific filters that
mirror AFNI’s voxel grouping.</p>
</div>
<div class="section level2">
<h2 id="diagnostics-and-sandwich-estimates">Diagnostics and sandwich estimates<a class="anchor" aria-label="anchor" href="#diagnostics-and-sandwich-estimates"></a>
</h2>
<p>The package includes helpers for quick diagnostics and variance
estimation:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Autocorrelation diagnostics for whitened residuals</span></span>
<span><span class="va">acorr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/acorr_diagnostics.html">acorr_diagnostics</a></span><span class="op">(</span><span class="va">Yw</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">acorr</span></span>
<span><span class="co"># $lags</span></span>
<span><span class="co">#  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $acf</span></span>
<span><span class="co">#  [1]  0.392581599  0.360973704  0.310315389  0.322265370  0.374991747</span></span>
<span><span class="co">#  [6]  0.210502166  0.223249048  0.235552972  0.217492041  0.143651583</span></span>
<span><span class="co"># [11]  0.100407607  0.025318410  0.070841147  0.056705121  0.030469542</span></span>
<span><span class="co"># [16]  0.010908172  0.003657289 -0.015876436 -0.048598733 -0.084495619</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $ci</span></span>
<span><span class="co"># [1] 0.1265175</span></span>
<span></span>
<span><span class="co"># Sandwich standard errors from whitened residuals</span></span>
<span><span class="va">sandwich</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sandwich_from_whitened_resid.html">sandwich_from_whitened_resid</a></span><span class="op">(</span><span class="va">whitened</span><span class="op">$</span><span class="va">X</span>, <span class="va">whitened</span><span class="op">$</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sandwich</span><span class="op">$</span><span class="va">se</span></span>
<span><span class="co">#           [,1]      [,2]      [,3]</span></span>
<span><span class="co"># [1,] 0.1161948 0.1309954 0.1219902</span></span>
<span><span class="co"># [2,] 0.1629742 0.1837334 0.1711027</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="next-steps">Next steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>Explore the test suite in <code>tests/testthat</code> for additional
usage patterns, including multiscale pooling and ARMA recovery
checks.</li>
<li>Inspect the exported <code>fmriAR_plan</code> object with
<code>plan_info()</code> to see per-run or per-parcel coefficients.</li>
<li>Combine <code><a href="../reference/whiten_apply.html">whiten_apply()</a></code> with GLS modelling packages to
build end-to-end prewhitened analyses.</li>
</ul>
<p>For production usage, consider benchmarking with your acquisition
parameters and reviewing the package README for tuning options such as
thread control and censor handling.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Your Name.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
